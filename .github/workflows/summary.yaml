name: Ka0s Summary

on:
    workflow_dispatch:
    schedule:
      - cron: '0 0 * * *' # Ejecutar diariamente a medianoche

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

jobs:
  kaos-init-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
      # Checkout the repository to get the information of the commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.KAOS_TOKEN }}

      - name: Set Info about Commit temp vars
        # Set the branch name and team name and file implicit in commit and save it in the environment variable
        run: |
          BRANCH_NAME=${{ github.event.base_ref }}
          USER_NAME=${{ github.actor.name}}
          USER_EMAIL=${{ github.actor.email }}
          PATH_RESUME="./observability/data/github/"
          KAOS_MODULE="[CORE SUMMARY]"
          KAOS_STEP_MODULE=""
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "USER_NAME=$USER_NAME" >> $GITHUB_ENV
          echo "USER_EMAIL=$USER_EMAIL" >> $GITHUB_ENV
          echo "PATH_RESUME=$PATH_RESUME" >> $GITHUB_ENV
          echo "KAOS_MODULE=$KAOS_MODULE" >> $GITHUB_ENV
          echo "KAOS_STEP_MODULE=$KAOS_STEP_MODULE" >> $GITHUB_ENV
          echo "DATETIME=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      - name: Summary Audit Log
        env:
           GH_TOKEN: ${{ secrets.KAOS_ISSUE_TOKEN }}
           GH_REPO: ${{ secrets.KAOS_REPO }}
        run: |
             #  Extraemos toda la información de las issues haste el momento
             gh issue list --repo $GH_REPO --state all --json assignees,author,body,closed,closedAt,comments,createdAt,id,labels,milestone,number,projectCards,projectItems,reactionGroups,state,title,updatedAt,url > ${{ env.PATH_RESUME }}kaos-issue-log-${{ env.DATETIME }}.json
             
      - name: Upload files to Repo
        env:
           GH_TOKEN: ${{ secrets.KAOS_TOKEN }}
        run: |  
             # Al ser un proceso nocturno le vamos a añadir la funcionalidad de hacer push a la rama para integrar los ficheros
             git config --global user.email ${{ secrets.KAOS_USER_EMAIL }}
             git config --global user.name ${{ secrets.KAOS_USER_NAME }}
             git add ${{ env.PATH_RESUME }}*
             git commit -m "[KA0S] We integrate the issue ${{ env.DATETIME }} summary in the repository, please approve PR"
             git push

      - name: Upload parameter file
        uses: actions/upload-artifact@v4
        with:
          name: reports-issue-files
          path: |
            ${{ env.PATH_RESUME }}kaos-issue-log-${{ env.DATETIME }}.json
      
      - name: Check execution
        env:
          GH_TOKEN: ${{ secrets.KAOS_TOKEN }}
          GH_ISSUE_ID: ${{ vars.KAOS_ISSUE_ID }}
        if: failure()
        run: |
          echo "Error detected in KaoS INIT, creating issue..."
          KAOS_ISSUE_TITLE="${{ env.KAOS_MODULE }} Action Failed: ${{ github.workflow }}"
          KAOS_ISSUE_BODY=$(cat <<'EOF'
          An error occurred in the ${{ env.KAOS_MODULE }} Action workflow **${{ github.workflow }}**.
          **[KAOS INIT]  Message:**
          \`\`\`
          **Please check the job logs for ${{ secrets.KAOS_ACTIONS_URL }}${{ github.run_id }}**
          \`\`\`
          **Workflow Name:** ${{ github.workflow }}
          **Job Name:** ${{ github.job }}
          **Run ID:** ${{ github.run_id }}
          **Run Number:** ${{ github.run_number }}
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref }}
          **Commit:** ${{ github.sha }}
          **Files Involved:**
          ${{ env.INVOLVED }}
          Please investigate the issue.
          EOF
          )
          gh issue create --title "$KAOS_ISSUE_TITLE" --body "$KAOS_ISSUE_BODY" --label "bug,core" --repo ${{ github.repository }}
  
  